<!DOCTYPE html>
<html>
    <head>
        <title>Takala</title>
    </head>
    <body>
        <div style="text-align: right">
            <a href="/login.html" id="login"><button>Login</button></a>
            <a href="/register.html" id="register"><button>Register</button></a>
            <p id="account"></p>
            <button id="logout" onclick="logout();">Logout</button>
        </div>

        <hr />
        <div>
            <h1>My name is Takala.</h1>
            <p>41047025S</p>
            <div>
                <h4>
                    <a href="/video.html" id="video"
                        ><button>Something Interesting</button></a
                    >
                </h4>
                <h3>Let leave a message</h3>
                <input id="message_input" type="text" />
                <button id="send_message" onclick="send_message();">
                    SEND
                </button>
            </div>
            <div id="messages"></div>
        </div>
    </body>
    <script>
        async function update_message() {
            const response = await fetch("/api/message");
            const body = await response.json();

            if (!response.ok) throw Error(response.statusText);

            let messages = document.querySelector("#messages");
            messages.innerHTML = "";
            for (let i = 0; i < body.length; i++) {
                let p = document.createElement("p");
                p.innerHTML = body[i].account + ": " + body[i].message;
                messages.appendChild(p);
            }
        }

        async function send_message() {
            let message_input = document.querySelector("#message_input");
            account = await get_account();
            if (account == "") {
                account = "Anonymous";
            }
            fetch("/api/left_message", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    account: account,
                    message: message_input.value,
                }),
            }).then((response) => {
                update_message();
                message_input.value = "";
            });
        }

        async function get_account() {
            let respond = await fetch("/api/get_account", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            });
            body = await respond.json();
            return body["account"];
        }

        async function check_login() {
            let account = await get_account();
            if (account != "") {
                document.querySelector("#login").style.display = "none";
                document.querySelector("#register").style.display = "none";
                document.querySelector("#account").style.display = "inline";
                document.querySelector("#account").innerHTML = account;
                document.querySelector("#logout").style.display = "inline";
            } else {
                document.querySelector("#login").style.display = "inline";
                document.querySelector("#register").style.display = "inline";
                document.querySelector("#account").style.display = "none";
                document.querySelector("#logout").style.display = "none";
            }
        }

        async function logout() {
            const response = await fetch("/api/logout", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
            });
            if (response.ok) {
                alert("Logout success!");
                window.location.href = "/index.html";
            } else {
                alert("Logout failed!");
            }
        }

        function main() {
            update_message();
            check_login();
        }
        main();
    </script>
</html>
